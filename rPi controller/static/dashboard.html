<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARS ‚Äî LCARS Interface</title>
    <style>
        /* ================================================================
           LCARS Interface - Following the Manifesto
           Key principles:
           - The Swept is LCARS (thick‚Üíthin corner transitions)
           - Frames NEVER same thickness on next turn
           - Rounded caps mark termination/buttons
           - Minimalism: empty space with useful frames is beautiful
           - 3 font sizes only (title, sub-header, data)
           - Max 4-5 colors with semantic meaning
           ================================================================ */
        
        @import url('https://fonts.googleapis.com/css2?family=Antonio:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* LCARS color palette - default Classic TNG colors */
            /* These are dynamically updated based on user's palette selection */
            --lcars-black: #000000;
            --lcars-orange: #ff8800;      /* Primary: active/important */
            --lcars-peach: #ff8866;       /* Secondary: data display */
            --lcars-tan: #ffaa00;         /* Tertiary: frames/structure */
            --lcars-blue: #cc99ff;        /* Quaternary: interactive (violet) */
            --lcars-purple: #99ccff;      /* Quinary: status/info (ice) */
            --lcars-sunflower: #ffcc99;   /* Light accent */
            
            /* Semantic (derived from palette) */
            --lcars-alert: #ff5555;       /* Alert state (tomato) */
            --lcars-ok: #99cc66;          /* OK state */
            
            /* Spacing constants (invisible grid) */
            --frame-gap: 6px;
            --cap-radius: 20px;
            --swept-radius: 40px;

            /* Swept elbow geometry (match thick‚Üíthin transitions) */
            --header-thick: 60px;
            --header-thin: 40px;
            --header-cutout-h: 20px; /* = thick - thin */
            --header-cutout-w: 40px;

            --footer-thick: 30px;
            --footer-thin: 20px;
            --footer-cutout-h: 10px; /* = thick - thin */
            --footer-cutout-w: 40px;

            --sidebar-elbow-h: 60px;
            --sidebar-cutout-h: 30px;
            --sidebar-cutout-w: 40px;
            
            /* Font sizes (only 3 as per manifesto) */
            --font-title: 28px;
            --font-subhead: 16px;
            --font-data: 14px;
        }
        
        body {
            font-family: 'Antonio', 'Helvetica Neue', Arial, sans-serif;
            background: var(--lcars-black);
            color: var(--lcars-sunflower);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ================================================================
           LCARS Core Structure - The Frame
           ================================================================ */
        
        .lcars-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Top Frame Bar with Swept corners */
        .lcars-header {
            display: flex;
            height: var(--header-thick);
            gap: var(--frame-gap);
        }
        
        /* Left swept elbow - thick to thin (LCARS cornerstone)
           The swept creates an L-shaped elbow with inner curve cutout */
        .lcars-header-swept {
            width: 180px;
            height: var(--header-thick);
            background: var(--lcars-orange);
            border-bottom-right-radius: var(--swept-radius);
            flex-shrink: 0;
            position: relative;
        }
        
        /* Inner curve cutout - sized to match thickness transition (60-40=20px height) */
        .lcars-header-swept::after {
            content: '';
            position: absolute;
            right: 0;
            bottom: 0;
            width: var(--header-cutout-w);
            height: var(--header-cutout-h);
            background: var(--lcars-black);
            border-top-left-radius: var(--header-cutout-h);
        }
        
        /* Top bar - extends across (thinner than elbow = thick‚Üíthin transition) */
        .lcars-header-bar {
            flex: 1;
            height: var(--header-thin);
            background: var(--lcars-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .lcars-header-title {
            font-size: var(--font-title);
            font-weight: 700;
            color: var(--lcars-black);
            text-transform: uppercase;
            letter-spacing: 4px;
        }
        
        /* Header cap buttons - rounded termination */
        .lcars-header-caps {
            display: flex;
            gap: var(--frame-gap);
            height: 40px;
        }
        
        .lcars-cap {
            height: 40px;
            padding: 0 25px;
            background: var(--lcars-tan);
            border-radius: var(--cap-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-subhead);
            font-weight: 700;
            color: var(--lcars-black);
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .lcars-cap:hover {
            background: var(--lcars-peach);
        }
        
        .lcars-cap.status {
            background: var(--lcars-purple);
            cursor: default;
            gap: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--lcars-alert);
        }
        
        .status-dot.connected {
            background: var(--lcars-ok);
        }
        
        /* ================================================================
           Main Content Area
           ================================================================ */
        
        .lcars-body {
            display: flex;
            flex: 1;
            gap: var(--frame-gap);
            padding-top: var(--frame-gap);
        }
        
        /* Left sidebar - vertical bar with buttons */
        .lcars-sidebar {
            width: 180px;
            display: flex;
            flex-direction: column;
            gap: var(--frame-gap);
            flex-shrink: 0;
        }
        
        /* Sidebar buttons - caps that extend from swept */
        .lcars-sidebar-btn {
            height: 36px;
            background: var(--lcars-tan);
            border-radius: 0 var(--cap-radius) var(--cap-radius) 0;
            display: flex;
            align-items: center;
            padding-left: 20px;
            font-size: var(--font-subhead);
            font-weight: 700;
            color: var(--lcars-black);
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .lcars-sidebar-btn:hover {
            background: var(--lcars-peach);
        }
        
        .lcars-sidebar-btn.active {
            background: var(--lcars-orange);
        }
        
        /* Spacer bar in sidebar */
        .lcars-sidebar-spacer {
            flex: 1;
            background: var(--lcars-tan);
            min-height: 20px;
        }
        
        /* Bottom swept elbow - curves at top-right (upward) for bottom corner */
        .lcars-sidebar-swept {
            height: 60px;
            background: var(--lcars-tan);
            border-top-right-radius: var(--swept-radius);
            position: relative;
        }
        
        .lcars-sidebar-swept::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            width: 40px;
            height: 30px;
            background: var(--lcars-black);
            border-bottom-left-radius: 30px;
        }
        
        /* ================================================================
           Content Panels
           ================================================================ */
        
        .lcars-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--frame-gap);
            padding-right: 20px;
            padding-bottom: 20px;
        }
        
        /* Robot state banner - prominent status */
        .lcars-banner {
            height: 50px;
            background: var(--lcars-purple);
            border-radius: var(--cap-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-title);
            font-weight: 700;
            color: var(--lcars-black);
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        
        .lcars-banner.enabled {
            background: var(--lcars-ok);
        }
        
        .lcars-banner.disabled {
            background: var(--lcars-alert);
        }
        
        /* Panel grid */
        .lcars-panels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--frame-gap);
            flex: 1;
        }
        
        /* Individual panel - frame with thick top, thin sides */
        .lcars-panel {
            background: rgba(20, 20, 30, 0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Panel header bar - thick (frame principle) */
        .lcars-panel-header {
            height: 32px;
            background: var(--lcars-tan);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
        }
        
        .lcars-panel-header.primary {
            background: var(--lcars-orange);
        }
        
        .lcars-panel-header.secondary {
            background: var(--lcars-blue);
        }
        
        .lcars-panel-title {
            font-size: var(--font-subhead);
            font-weight: 700;
            color: var(--lcars-black);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .lcars-panel-badge {
            margin-left: auto;
            font-size: 11px;
            padding: 2px 10px;
            background: var(--lcars-black);
            color: var(--lcars-peach);
            border-radius: 10px;
        }
        
        /* Panel content - thin border continuation */
        .lcars-panel-body {
            flex: 1;
            padding: 15px;
            border-left: 4px solid var(--lcars-tan);
            border-right: 4px solid var(--lcars-tan);
            border-bottom: 4px solid var(--lcars-tan);
        }
        
        .lcars-panel-body.primary-border {
            border-color: var(--lcars-orange);
        }
        
        .lcars-panel-body.secondary-border {
            border-color: var(--lcars-blue);
        }
        
        /* Data rows */
        .lcars-data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(204, 153, 102, 0.2);
        }
        
        .lcars-data-row:last-child {
            border-bottom: none;
        }
        
        .lcars-data-label {
            font-size: var(--font-data);
            color: var(--lcars-tan);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .lcars-data-value {
            font-size: var(--font-subhead);
            font-weight: 700;
            color: var(--lcars-peach);
        }
        
        .lcars-data-value.ok { color: var(--lcars-ok); }
        .lcars-data-value.alert { color: var(--lcars-alert); }
        .lcars-data-value.warn { color: var(--lcars-orange); }
        
        /* Big metrics display */
        .lcars-metric {
            text-align: center;
            padding: 10px;
        }
        
        .lcars-metric-value {
            font-size: 42px;
            font-weight: 700;
            color: var(--lcars-orange);
            line-height: 1;
        }
        
        .lcars-metric-unit {
            font-size: var(--font-subhead);
            color: var(--lcars-tan);
        }
        
        .lcars-metric-label {
            font-size: 11px;
            color: var(--lcars-tan);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 5px;
        }
        
        .lcars-metric-row {
            display: flex;
            justify-content: space-around;
        }
        
        /* Status grid */
        .lcars-status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .lcars-status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--lcars-blue);
        }
        
        .lcars-status-icon {
            font-size: 18px;
        }
        
        .lcars-status-label {
            font-size: 10px;
            color: var(--lcars-tan);
            text-transform: uppercase;
        }
        
        .lcars-status-state {
            font-size: var(--font-data);
            font-weight: 700;
        }
        
        .lcars-status-state.on { color: var(--lcars-ok); }
        .lcars-status-state.off { color: var(--lcars-alert); }
        
        /* Progress bars */
        .lcars-progress {
            height: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .lcars-progress-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .lcars-progress-fill.battery {
            background: linear-gradient(90deg, var(--lcars-alert), var(--lcars-orange), var(--lcars-ok));
        }
        
        .lcars-progress-fill.temp {
            background: linear-gradient(90deg, var(--lcars-blue), var(--lcars-orange), var(--lcars-alert));
        }
        
        /* IMU gauges */
        .lcars-imu-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 10px 0;
        }
        
        .lcars-imu-gauge {
            text-align: center;
        }
        
        .lcars-imu-ring {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid var(--lcars-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .lcars-imu-needle {
            position: absolute;
            width: 3px;
            height: 28px;
            background: var(--lcars-orange);
            transform-origin: bottom center;
            bottom: 50%;
            left: calc(50% - 1.5px);
            border-radius: 2px;
            transition: transform 0.2s;
        }
        
        .lcars-imu-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--lcars-peach);
        }
        
        .lcars-imu-label {
            font-size: 10px;
            color: var(--lcars-tan);
            text-transform: uppercase;
            margin-top: 6px;
            letter-spacing: 1px;
        }
        
        /* Link buttons */
        .lcars-link-btn {
            display: inline-block;
            padding: 10px 20px;
            background: var(--lcars-blue);
            border-radius: var(--cap-radius);
            color: var(--lcars-black);
            text-decoration: none;
            font-size: var(--font-data);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
            transition: background 0.15s;
        }
        
        .lcars-link-btn:hover {
            background: var(--lcars-peach);
        }
        
        /* ================================================================
           Config Panel - spans full width
           ================================================================ */
        
        .lcars-panel.wide {
            grid-column: span 3;
        }
        
        .lcars-config-search {
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--lcars-blue);
            border-radius: var(--cap-radius);
            color: var(--lcars-peach);
            font-size: var(--font-data);
            font-family: inherit;
        }
        
        .lcars-config-search:focus {
            outline: none;
            border-color: var(--lcars-orange);
        }
        
        .lcars-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
        }
        
        .lcars-config-category {
            background: rgba(0, 0, 0, 0.3);
            border-left: 4px solid var(--lcars-purple);
            overflow: hidden;
        }
        
        .lcars-config-category.collapsed .lcars-config-items {
            display: none;
        }
        
        .lcars-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(204, 153, 204, 0.2);
            cursor: pointer;
        }
        
        .lcars-config-header:hover {
            background: rgba(204, 153, 204, 0.3);
        }
        
        .lcars-config-title {
            font-size: var(--font-data);
            font-weight: 700;
            color: var(--lcars-peach);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .lcars-config-toggle {
            color: var(--lcars-tan);
            transition: transform 0.2s;
        }
        
        .lcars-config-category.collapsed .lcars-config-toggle {
            transform: rotate(-90deg);
        }
        
        .lcars-config-count {
            font-size: 11px;
            color: var(--lcars-tan);
            margin-left: 8px;
        }
        
        .lcars-config-items {
            padding: 8px 12px;
        }
        
        .lcars-config-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
            border-bottom: 1px solid rgba(204, 153, 204, 0.1);
        }
        
        .lcars-config-item:last-child {
            border-bottom: none;
        }
        
        .lcars-config-label {
            color: var(--lcars-tan);
        }
        
        .lcars-config-value {
            color: var(--lcars-orange);
            font-weight: 700;
        }
        
        /* Editable config input */
        .lcars-config-input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--lcars-tan);
            border-radius: 4px;
            color: var(--lcars-orange);
            font-size: 12px;
            font-weight: 700;
            padding: 2px 6px;
            width: 80px;
            text-align: right;
        }
        
        .lcars-config-input:focus {
            outline: none;
            border-color: var(--lcars-orange);
            background: rgba(0, 0, 0, 0.7);
        }
        
        .lcars-config-input:hover {
            border-color: var(--lcars-peach);
        }
        
        /* Editable config select (dropdown) */
        .lcars-config-select {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--lcars-tan);
            border-radius: 4px;
            color: var(--lcars-orange);
            font-size: 12px;
            font-weight: 700;
            padding: 2px 6px;
            min-width: 80px;
            cursor: pointer;
        }
        
        .lcars-config-select:focus {
            outline: none;
            border-color: var(--lcars-orange);
            background: rgba(0, 0, 0, 0.7);
        }
        
        .lcars-config-select:hover {
            border-color: var(--lcars-peach);
        }
        
        .lcars-config-select option {
            background: #1a1a2e;
            color: var(--lcars-tan);
        }
        
        .lcars-config-item.hidden {
            display: none;
        }
        
        .lcars-config-empty {
            text-align: center;
            color: var(--lcars-tan);
            padding: 20px;
        }
        
        /* ================================================================
           Footer Bar
           ================================================================ */
        
        .lcars-footer {
            display: flex;
            height: var(--footer-thick);
            gap: var(--frame-gap);
            margin-top: var(--frame-gap);
        }
        
        /* Footer swept elbow - curves at top-right (upward) for bottom corner */
        .lcars-footer-swept {
            width: 180px;
            background: var(--lcars-tan);
            border-top-right-radius: var(--swept-radius);
            position: relative;
        }
        
        .lcars-footer-swept::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            width: var(--footer-cutout-w);
            height: var(--footer-cutout-h);
            background: var(--lcars-black);
            border-bottom-left-radius: var(--footer-cutout-h);
        }
        
        .lcars-footer-bar {
            flex: 1;
            height: var(--footer-thin);
            background: var(--lcars-tan);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .lcars-footer-text {
            font-size: 11px;
            font-weight: 700;
            color: var(--lcars-black);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .lcars-footer-cap {
            width: 80px;
            height: 20px;
            background: var(--lcars-orange);
            border-radius: var(--cap-radius);
        }
        
        /* ================================================================
           Connection Dialog
           ================================================================ */
        
        .lcars-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--lcars-black);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .lcars-dialog.hidden {
            display: none;
        }
        
        .lcars-dialog-box {
            display: flex;
            flex-direction: column;
            gap: var(--frame-gap);
            min-width: 400px;
        }
        
        .lcars-dialog-header {
            height: 50px;
            background: var(--lcars-orange);
            border-radius: 0 var(--cap-radius) var(--cap-radius) 0;
            display: flex;
            align-items: center;
            padding-left: 25px;
        }
        
        .lcars-dialog-title {
            font-size: var(--font-title);
            font-weight: 700;
            color: var(--lcars-black);
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        
        .lcars-dialog-body {
            background: rgba(20, 20, 30, 0.8);
            border-left: 8px solid var(--lcars-orange);
            border-right: 4px solid var(--lcars-tan);
            border-bottom: 4px solid var(--lcars-tan);
            padding: 30px;
            text-align: center;
        }
        
        .lcars-dialog-subtitle {
            font-size: var(--font-subhead);
            color: var(--lcars-tan);
            margin-bottom: 20px;
        }
        
        .lcars-dialog-input {
            width: 100%;
            padding: 12px 20px;
            background: var(--lcars-black);
            border: 2px solid var(--lcars-blue);
            border-radius: var(--cap-radius);
            color: var(--lcars-peach);
            font-size: var(--font-subhead);
            font-family: inherit;
            margin-bottom: 20px;
        }
        
        .lcars-dialog-input:focus {
            outline: none;
            border-color: var(--lcars-orange);
        }
        
        .lcars-dialog-btn {
            padding: 12px 40px;
            background: var(--lcars-peach);
            border: none;
            border-radius: var(--cap-radius);
            color: var(--lcars-black);
            font-size: var(--font-subhead);
            font-weight: 700;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .lcars-dialog-btn:hover {
            background: var(--lcars-orange);
        }
        
        /* ================================================================
           Responsive
           ================================================================ */
        
        @media (max-width: 1200px) {
            .lcars-panels {
                grid-template-columns: repeat(2, 1fr);
            }
            .lcars-panel.wide {
                grid-column: span 2;
            }
        }
        
        @media (max-width: 800px) {
            .lcars-body {
                flex-direction: column;
            }
            /* Keep navigation available on mobile: convert sidebar to horizontal bar */
            .lcars-sidebar {
                width: 100%;
                flex-direction: row;
                align-items: center;
                overflow-x: auto;
                overflow-y: hidden;
                padding: 0 12px;
                gap: 8px;
            }
            .lcars-sidebar-btn {
                height: 34px;
                padding: 0 14px;
                border-radius: var(--cap-radius);
                white-space: nowrap;
                flex: 0 0 auto;
            }
            .lcars-sidebar-spacer,
            .lcars-sidebar-swept {
                display: none;
            }
            .lcars-header-swept {
                width: 60px;
            }
            .lcars-footer-swept {
                width: 60px;
            }
            .lcars-panels {
                grid-template-columns: 1fr;
            }
            .lcars-panel.wide {
                grid-column: span 1;
            }
            .lcars-content {
                padding-right: 12px;
                padding-left: 12px;
                padding-bottom: 12px;
            }
        }

        @media (max-width: 600px) {
            :root {
                --font-title: 22px;
                --font-subhead: 14px;
                --font-data: 13px;
                --cap-radius: 16px;
                --swept-radius: 28px;
                --frame-gap: 5px;
            }
            .lcars-header {
                height: auto;
                flex-wrap: wrap;
            }
            .lcars-header-bar {
                height: 40px;
                justify-content: flex-start;
                padding-left: 12px;
            }
            .lcars-header-title {
                letter-spacing: 2px;
            }
            .lcars-header-caps {
                height: 40px;
                padding-right: 12px;
            }
            .lcars-banner {
                font-size: 20px;
                padding: 0 12px;
                text-align: center;
            }
            .lcars-metric-row {
                flex-wrap: wrap;
                gap: 10px;
            }
            .lcars-metric-value {
                font-size: 36px;
            }
            /* Make config rows readable on narrow screens */
            .lcars-config-item {
                flex-direction: column;
                gap: 6px;
                align-items: flex-start;
            }
            .lcars-config-input,
            .lcars-config-select {
                width: 100%;
                min-width: 0;
                text-align: left;
                padding: 8px 10px;
                font-size: var(--font-subhead);
            }
        }
        
        /* ================================================================
           W4: Charts & Graphs
           ================================================================ */
        .lcars-chart-container {
            position: relative;
            height: 200px;
            width: 100%;
            margin: 8px 0;
        }
        .lcars-chart-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .lcars-chart-btn {
            background: var(--lcars-tan);
            color: var(--lcars-black);
            border: none;
            padding: 4px 12px;
            border-radius: 10px;
            font-family: inherit;
            font-size: var(--font-data);
            cursor: pointer;
            transition: background 0.2s;
        }
        .lcars-chart-btn:hover {
            background: var(--lcars-orange);
        }
        .lcars-chart-btn.active {
            background: var(--lcars-orange);
        }
        .lcars-chart-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            border-bottom: 2px solid var(--lcars-tan);
            padding-bottom: 4px;
        }
        .lcars-chart-tab {
            background: transparent;
            color: var(--lcars-sunflower);
            border: none;
            padding: 6px 16px;
            font-family: inherit;
            font-size: var(--font-data);
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            transition: background 0.2s, color 0.2s;
        }
        .lcars-chart-tab:hover {
            background: rgba(255, 136, 0, 0.2);
        }
        .lcars-chart-tab.active {
            background: var(--lcars-tan);
            color: var(--lcars-black);
        }
        .lcars-chart-legend {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 8px;
            font-size: var(--font-data);
        }
        .lcars-chart-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .lcars-chart-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
    </style>
    <!-- Chart.js for W4 graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Connection Dialog -->
    <div class="lcars-dialog" id="connection-dialog">
        <div class="lcars-dialog-box">
            <div class="lcars-dialog-header">
                <span class="lcars-dialog-title">MARS</span>
            </div>
            <div class="lcars-dialog-body">
                <div class="lcars-dialog-subtitle">Modular Autonomous Robotic System</div>
                <input type="text" class="lcars-dialog-input" id="ws-address" placeholder="ws://192.168.1.100:8766">
                <br>
                <button class="lcars-dialog-btn" onclick="connect()">Engage</button>
            </div>
        </div>
    </div>
    
    <!-- Main Interface -->
    <div id="dashboard" style="display: none;">
        <div class="lcars-container">
            
            <!-- Header Bar -->
            <div class="lcars-header">
                <div class="lcars-header-swept"></div>
                <div class="lcars-header-bar">
                    <span class="lcars-header-title">MARS Dashboard</span>
                </div>
                <div class="lcars-header-caps">
                    <div class="lcars-cap status">
                        <span class="status-dot" id="ws-status"></span>
                        <span id="connection-text">Offline</span>
                    </div>
                </div>
            </div>
            
            <!-- Body -->
            <div class="lcars-body">
                
                <!-- Sidebar -->
                <div class="lcars-sidebar">
                    <div class="lcars-sidebar-btn active">Status</div>
                    <div class="lcars-sidebar-btn">Power</div>
                    <div class="lcars-sidebar-btn">Servos</div>
                    <div class="lcars-sidebar-btn">IMU</div>
                    <div class="lcars-sidebar-btn">Gait</div>
                    <div class="lcars-sidebar-btn">Config</div>
                    <div class="lcars-sidebar-spacer"></div>
                    <div class="lcars-sidebar-swept"></div>
                </div>
                
                <!-- Content -->
                <div class="lcars-content">
                    
                    <!-- Robot State Banner -->
                    <div class="lcars-banner disabled" id="robot-banner">
                        Robot Disabled
                    </div>
                    
                    <!-- Panels Grid -->
                    <div class="lcars-panels">
                        
                        <!-- Power Panel -->
                        <div class="lcars-panel">
                            <div class="lcars-panel-header primary">
                                <span class="lcars-panel-title">Power</span>
                            </div>
                            <div class="lcars-panel-body primary-border">
                                <div class="lcars-metric-row">
                                    <div class="lcars-metric">
                                        <div class="lcars-metric-value"><span id="battery-v">--</span><span class="lcars-metric-unit">V</span></div>
                                        <div class="lcars-metric-label">Battery</div>
                                        <div class="lcars-progress" style="width: 80px; margin: 8px auto 0;">
                                            <div class="lcars-progress-fill battery" id="battery-bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="lcars-metric">
                                        <div class="lcars-metric-value"><span id="current-a">--</span><span class="lcars-metric-unit">A</span></div>
                                        <div class="lcars-metric-label">Current</div>
                                    </div>
                                </div>
                                <div class="lcars-data-row">
                                    <span class="lcars-data-label">Low Batt Protection</span>
                                    <span class="lcars-data-value" id="low-battery-status">---</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Panel -->
                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <span class="lcars-panel-title">Systems</span>
                            </div>
                            <div class="lcars-panel-body">
                                <div class="lcars-status-grid">
                                    <div class="lcars-status-item">
                                        <span class="lcars-status-icon">üéÆ</span>
                                        <div>
                                            <div class="lcars-status-label">Xbox</div>
                                            <div class="lcars-status-state off" id="xbox-status">---</div>
                                        </div>
                                    </div>
                                    <div class="lcars-status-item">
                                        <span class="lcars-status-icon">üîå</span>
                                        <div>
                                            <div class="lcars-status-label">Teensy</div>
                                            <div class="lcars-status-state off" id="teensy-status">---</div>
                                        </div>
                                    </div>
                                    <div class="lcars-status-item">
                                        <span class="lcars-status-icon">ü¶ø</span>
                                        <div>
                                            <div class="lcars-status-label">Gait</div>
                                            <div class="lcars-status-state off" id="gait-status">---</div>
                                        </div>
                                    </div>
                                    <div class="lcars-status-item">
                                        <span class="lcars-status-icon">üõ°Ô∏è</span>
                                        <div>
                                            <div class="lcars-status-label">Safety</div>
                                            <div class="lcars-status-state" id="safety-status">---</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="lcars-data-row" style="margin-top: 10px;">
                                    <span class="lcars-data-label">Safety Cause</span>
                                    <span class="lcars-data-value" id="safety-cause">---</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- IMU Panel -->
                        <div class="lcars-panel">
                            <div class="lcars-panel-header secondary">
                                <span class="lcars-panel-title">IMU</span>
                            </div>
                            <div class="lcars-panel-body secondary-border">
                                <div class="lcars-imu-row">
                                    <div class="lcars-imu-gauge">
                                        <div class="lcars-imu-ring">
                                            <div class="lcars-imu-needle" id="pitch-needle"></div>
                                            <span class="lcars-imu-value" id="pitch-value">0¬∞</span>
                                        </div>
                                        <div class="lcars-imu-label">Pitch</div>
                                    </div>
                                    <div class="lcars-imu-gauge">
                                        <div class="lcars-imu-ring">
                                            <div class="lcars-imu-needle" id="roll-needle"></div>
                                            <span class="lcars-imu-value" id="roll-value">0¬∞</span>
                                        </div>
                                        <div class="lcars-imu-label">Roll</div>
                                    </div>
                                    <div class="lcars-imu-gauge">
                                        <div class="lcars-imu-ring">
                                            <div class="lcars-imu-needle" id="yaw-needle"></div>
                                            <span class="lcars-imu-value" id="yaw-value">0¬∞</span>
                                        </div>
                                        <div class="lcars-imu-label">Yaw</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Servos Panel -->
                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <span class="lcars-panel-title">Servos</span>
                            </div>
                            <div class="lcars-panel-body">
                                <div class="lcars-data-row">
                                    <span class="lcars-data-label">Max Temp</span>
                                    <span class="lcars-data-value" id="servo-temp">--¬∞C</span>
                                </div>
                                <div class="lcars-progress">
                                    <div class="lcars-progress-fill temp" id="temp-bar" style="width: 0%"></div>
                                </div>
                                <div class="lcars-data-row" style="margin-top: 12px;">
                                    <span class="lcars-data-label">Min Voltage</span>
                                    <span class="lcars-data-value" id="servo-volt">--V</span>
                                </div>
                                <div class="lcars-data-row">
                                    <span class="lcars-data-label">Errors</span>
                                    <span class="lcars-data-value" id="servo-errors">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gait Panel -->
                        <div class="lcars-panel">
                            <div class="lcars-panel-header">
                                <span class="lcars-panel-title">Gait</span>
                            </div>
                            <div class="lcars-panel-body">
                                <div class="lcars-data-row">
                                    <span class="lcars-data-label">Type</span>
                                    <span class="lcars-data-value" id="gait-type">---</span>
                                </div>
                                <div class="lcars-data-row">
                                    <span class="lcars-data-label">Speed</span>
                                    <span class="lcars-data-value" id="gait-speed">---</span>
                                </div>
                                <div class="lcars-data-row">
                                    <span class="lcars-data-label">Running</span>
                                    <span class="lcars-data-value" id="gait-running">No</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- System Panel -->
                        <div class="lcars-panel">
                            <div class="lcars-panel-header primary">
                                <span class="lcars-panel-title">Computer</span>
                            </div>
                            <div class="lcars-panel-body primary-border">
                                <div class="lcars-data-row">
                                    <span class="lcars-data-label">Loop Time</span>
                                    <span class="lcars-data-value" id="loop-time">---</span>
                                </div>
                                <div class="lcars-data-row">
                                    <span class="lcars-data-label">Firmware</span>
                                    <span class="lcars-data-value" id="fw-version">---</span>
                                </div>
                                <div class="lcars-data-row">
                                    <span class="lcars-data-label">Controller</span>
                                    <span class="lcars-data-value" id="ctrl-version">---</span>
                                </div>
                                <a href="/pointcloud" class="lcars-link-btn" target="_blank">Point Cloud</a>
                            </div>
                        </div>
                        
                        <!-- Config Panel (wide) -->
                        <div class="lcars-panel wide">
                            <div class="lcars-panel-header secondary">
                                <span class="lcars-panel-title">Configuration</span>
                                <span class="lcars-panel-badge">Live Edit</span>
                            </div>
                            <div class="lcars-panel-body secondary-border">
                                <input type="text" 
                                       class="lcars-config-search" 
                                       id="config-search" 
                                       placeholder="Search configuration..."
                                       oninput="filterConfig(this.value)">
                                <div class="lcars-config-grid" id="config-container">
                                    <div class="lcars-config-empty">Configuration loading...</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts Panel (wide) - W4 -->
                        <div class="lcars-panel wide">
                            <div class="lcars-panel-header primary">
                                <span class="lcars-panel-title">Telemetry History</span>
                                <span class="lcars-panel-badge" id="chart-sample-count">0 samples</span>
                            </div>
                            <div class="lcars-panel-body primary-border">
                                <!-- Chart tabs -->
                                <div class="lcars-chart-tabs">
                                    <button class="lcars-chart-tab active" onclick="showChart('voltage')" id="tab-voltage">Voltage</button>
                                    <button class="lcars-chart-tab" onclick="showChart('looptime')" id="tab-looptime">Loop Time</button>
                                    <button class="lcars-chart-tab" onclick="showChart('temperature')" id="tab-temperature">Temperature</button>
                                    <button class="lcars-chart-tab" onclick="showChart('overlay')" id="tab-overlay">Overlay All</button>
                                </div>
                                <!-- Chart controls -->
                                <div class="lcars-chart-controls">
                                    <button class="lcars-chart-btn" onclick="setChartWindow(60)">1 min</button>
                                    <button class="lcars-chart-btn active" onclick="setChartWindow(300)">5 min</button>
                                    <button class="lcars-chart-btn" onclick="setChartWindow(600)">10 min</button>
                                    <button class="lcars-chart-btn" onclick="clearHistory()">Clear</button>
                                    <button class="lcars-chart-btn" onclick="exportCSV()">Export CSV</button>
                                </div>
                                <!-- Chart canvas -->
                                <div class="lcars-chart-container">
                                    <canvas id="telemetry-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="lcars-footer">
                <div class="lcars-footer-swept"></div>
                <div class="lcars-footer-bar">
                    <span class="lcars-footer-text">MARS ‚Äî Modular Autonomous Robotic System</span>
                    <span class="lcars-footer-text" id="last-update">---</span>
                </div>
                <div class="lcars-footer-cap"></div>
            </div>
            
        </div>
    </div>
    
    <script>
        // =================================================================
        // Global state
        // =================================================================
        let ws = null;
        let config = {};
        let collapsedCategories = new Set();
        
        // =================================================================
        // W4: Telemetry History & Charts
        // =================================================================
        const MAX_HISTORY_SAMPLES = 3600;  // ~1 hour at 1 sample/sec
        let telemetryHistory = [];
        let chartWindowSeconds = 300;  // Default 5 minutes
        let currentChartType = 'voltage';
        let telemetryChart = null;
        
        function initChart() {
            const ctx = document.getElementById('telemetry-chart');
            if (!ctx) return;
            
            telemetryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Battery Voltage (V)',
                            data: [],
                            borderColor: '#ff8800',
                            backgroundColor: 'rgba(255, 136, 0, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.2,
                            pointRadius: 0,
                            yAxisID: 'y',
                        },
                        {
                            label: 'Loop Time (ms)',
                            data: [],
                            borderColor: '#cc99ff',
                            backgroundColor: 'rgba(204, 153, 255, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.2,
                            pointRadius: 0,
                            yAxisID: 'y1',
                            hidden: true,
                        },
                        {
                            label: 'Temperature (¬∞C)',
                            data: [],
                            borderColor: '#ff5555',
                            backgroundColor: 'rgba(255, 85, 85, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.2,
                            pointRadius: 0,
                            yAxisID: 'y2',
                            hidden: true,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: 'rgba(255, 170, 0, 0.2)' },
                            ticks: { color: '#ffcc99', maxTicksLimit: 8 }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: 'rgba(255, 170, 0, 0.2)' },
                            ticks: { color: '#ff8800' },
                            title: { display: false, text: 'Voltage (V)', color: '#ff8800' },
                            suggestedMin: 9,
                            suggestedMax: 13
                        },
                        y1: {
                            type: 'linear',
                            display: false,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#cc99ff' },
                            title: { display: false, text: 'Loop (ms)', color: '#cc99ff' },
                            suggestedMin: 0,
                            suggestedMax: 10
                        },
                        y2: {
                            type: 'linear',
                            display: false,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#ff5555' },
                            title: { display: false, text: 'Temp (¬∞C)', color: '#ff5555' },
                            suggestedMin: 20,
                            suggestedMax: 60
                        }
                    },
                    plugins: {
                        legend: { 
                            display: false,
                            labels: { color: '#ffcc99' }
                        }
                    }
                }
            });
        }
        
        function addTelemetrySample(data) {
            const sample = {
                timestamp: Date.now(),
                battery_v: data.battery_v || 0,
                loop_time_us: data.loop_time_us || 0,
                servo_temp_max: data.servo_temp_max || 0,
                servo_volt_min: data.servo_volt_min || 0,
                current_a: data.current_a || 0,
            };
            
            telemetryHistory.push(sample);
            
            // Trim old samples
            if (telemetryHistory.length > MAX_HISTORY_SAMPLES) {
                telemetryHistory = telemetryHistory.slice(-MAX_HISTORY_SAMPLES);
            }
            
            // Update sample count badge
            const badge = document.getElementById('chart-sample-count');
            if (badge) badge.textContent = `${telemetryHistory.length} samples`;
            
            updateChart();
        }
        
        function updateChart() {
            if (!telemetryChart) return;
            
            const now = Date.now();
            const windowMs = chartWindowSeconds * 1000;
            
            // Generate fixed time slots for the full window (100 slots)
            const NUM_SLOTS = 100;
            
            // Create labels for full time window (oldest on left, newest on right)
            let labels = [];
            for (let slot = 0; slot < NUM_SLOTS; slot++) {
                // slot 0 = oldest (full window age), slot 99 = newest (age 0)
                const ageSeconds = chartWindowSeconds * (1 - slot / (NUM_SLOTS - 1));
                const mins = Math.floor(ageSeconds / 60);
                const secs = Math.floor(ageSeconds % 60);
                labels.push(`-${mins}:${secs.toString().padStart(2, '0')}`);
            }
            
            // Initialize data arrays with nulls (gaps where no data)
            let voltageData = new Array(NUM_SLOTS).fill(null);
            let looptimeData = new Array(NUM_SLOTS).fill(null);
            let tempData = new Array(NUM_SLOTS).fill(null);
            
            // Map telemetry samples to time slots
            for (const s of telemetryHistory) {
                const age = now - s.timestamp;
                if (age > windowMs || age < 0) continue;
                
                // Map age to slot index: age=0 -> slot 99, age=windowMs -> slot 0
                const slotIndex = Math.round((1 - age / windowMs) * (NUM_SLOTS - 1));
                
                if (slotIndex >= 0 && slotIndex < NUM_SLOTS) {
                    // Use latest sample if multiple fall in same slot
                    voltageData[slotIndex] = s.battery_v;
                    looptimeData[slotIndex] = s.loop_time_us / 1000;
                    tempData[slotIndex] = s.servo_temp_max;
                }
            }
            
            telemetryChart.data.labels = labels;
            telemetryChart.data.datasets[0].data = voltageData;
            telemetryChart.data.datasets[1].data = looptimeData;
            telemetryChart.data.datasets[2].data = tempData;
            
            // Show/hide datasets and axes based on chart type
            const isOverlay = (currentChartType === 'overlay');
            
            // Dataset visibility
            telemetryChart.data.datasets[0].hidden = !(currentChartType === 'voltage' || isOverlay);
            telemetryChart.data.datasets[1].hidden = !(currentChartType === 'looptime' || isOverlay);
            telemetryChart.data.datasets[2].hidden = !(currentChartType === 'temperature' || isOverlay);
            
            // Axis visibility and titles
            telemetryChart.options.scales.y.display = (currentChartType === 'voltage' || isOverlay);
            telemetryChart.options.scales.y.title.display = isOverlay;
            telemetryChart.options.scales.y1.display = (currentChartType === 'looptime' || isOverlay);
            telemetryChart.options.scales.y1.title.display = isOverlay;
            telemetryChart.options.scales.y2.display = (currentChartType === 'temperature' || isOverlay);
            telemetryChart.options.scales.y2.title.display = isOverlay;
            
            // Legend visibility
            telemetryChart.options.plugins.legend.display = isOverlay;
            
            telemetryChart.update('none');
        }
        
        function showChart(type) {
            currentChartType = type;
            // Update tab styling
            document.querySelectorAll('.lcars-chart-tab').forEach(t => t.classList.remove('active'));
            const tab = document.getElementById('tab-' + type);
            if (tab) tab.classList.add('active');
            updateChart();
        }
        
        function setChartWindow(seconds) {
            chartWindowSeconds = seconds;
            // Update button styling
            document.querySelectorAll('.lcars-chart-btn').forEach(b => {
                if (b.textContent.includes('min')) b.classList.remove('active');
            });
            event.target.classList.add('active');
            updateChart();
        }
        
        function clearHistory() {
            telemetryHistory = [];
            const badge = document.getElementById('chart-sample-count');
            if (badge) badge.textContent = '0 samples';
            updateChart();
        }
        
        function exportCSV() {
            if (telemetryHistory.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Build CSV
            const headers = ['timestamp', 'battery_v', 'loop_time_us', 'servo_temp_max', 'servo_volt_min', 'current_a'];
            let csv = headers.join(',') + '\\n';
            
            for (const s of telemetryHistory) {
                const row = [
                    new Date(s.timestamp).toISOString(),
                    s.battery_v.toFixed(2),
                    s.loop_time_us.toFixed(0),
                    s.servo_temp_max.toFixed(1),
                    s.servo_volt_min.toFixed(2),
                    s.current_a.toFixed(2),
                ];
                csv += row.join(',') + '\\n';
            }
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mars_telemetry_${new Date().toISOString().slice(0,19).replace(/:/g, '')}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // =================================================================
        // Initialization
        // =================================================================
        
        function init() {
            const hostname = window.location.hostname || 'localhost';
            document.getElementById('ws-address').value = `ws://${hostname}:8766`;
            // Initialize chart (Chart.js loaded async)
            if (typeof Chart !== 'undefined') {
                initChart();
            } else {
                // Wait for Chart.js to load
                setTimeout(() => { if (typeof Chart !== 'undefined') initChart(); }, 500);
            }
        }
        
        // =================================================================
        // WebSocket connection
        // =================================================================
        
        function connect() {
            const address = document.getElementById('ws-address').value;
            
            if (ws) ws.close();
            
            try {
                ws = new WebSocket(address);
                
                ws.onopen = () => {
                    document.getElementById('ws-status').classList.add('connected');
                    document.getElementById('connection-text').textContent = 'Online';
                    document.getElementById('connection-dialog').classList.add('hidden');
                    document.getElementById('dashboard').style.display = 'block';
                    ws.send(JSON.stringify({ cmd: 'get_config' }));
                };
                
                ws.onclose = () => {
                    document.getElementById('ws-status').classList.remove('connected');
                    document.getElementById('connection-text').textContent = 'Offline';
                    document.getElementById('connection-dialog').classList.remove('hidden');
                };
                
                ws.onerror = (err) => console.error('WebSocket error:', err);
                ws.onmessage = (event) => handleMessage(JSON.parse(event.data));
                
            } catch (err) {
                console.error('Connection failed:', err);
                alert('Failed to connect: ' + err.message);
            }
        }
        
        function handleMessage(data) {
            if (data.type === 'telemetry') {
                updateTelemetry(data.data);
            } else if (data.type === 'config') {
                config = data.data;
                applyPalette();  // Apply LCARS palette from config
                renderConfig();
            } else if (data.type === 'config_result') {
                handleConfigResult(data);
            }
        }
        
        // =================================================================
        // LCARS Palettes (from display_thread.py)
        // =================================================================
        
        const LCARS_PALETTES = {
            'Classic': {
                orange: '#ff8800',
                gold: '#ffaa00',
                peach: '#ff8866',
                sunflower: '#ffcc99',
                violet: '#cc99ff',
                lilac: '#cc55ff',
                almond: '#ffaa90',
                ice: '#99ccff',
                sky: '#aaaaff',
                tomato: '#ff5555',
            },
            'Nemesis': {
                orange: '#6699ff',
                gold: '#88bbff',
                peach: '#2266ff',
                sunflower: '#ebf0ff',
                violet: '#9966cc',
                lilac: '#9966cc',
                almond: '#ccaa88',
                ice: '#88bbff',
                sky: '#6699ff',
                tomato: '#cc2233',
            },
            'LwrDecks': {
                orange: '#ff7700',
                gold: '#ff9911',
                peach: '#ffaa44',
                sunflower: '#ffeecc',
                violet: '#ff4400',
                lilac: '#cc5500',
                almond: '#ffcc99',
                ice: '#ffeecc',
                sky: '#ffcc99',
                tomato: '#ff4400',
            },
            'PADD': {
                orange: '#5588ee',
                gold: '#7799dd',
                peach: '#455580',
                sunflower: '#99ccff',
                violet: '#88ffff',
                lilac: '#66ccff',
                almond: '#99ccff',
                ice: '#88ffff',
                sky: '#66ccff',
                tomato: '#ff3500',
            }
        };
        
        function applyPalette() {
            // Get palette name from System config
            let paletteName = 'Classic';
            if (config && config.System && config.System.Palette) {
                paletteName = config.System.Palette;
            }
            
            const palette = LCARS_PALETTES[paletteName] || LCARS_PALETTES['Classic'];
            const root = document.documentElement;
            
            // Apply palette colors to CSS variables
            root.style.setProperty('--lcars-orange', palette.orange);
            root.style.setProperty('--lcars-tan', palette.gold);
            root.style.setProperty('--lcars-peach', palette.peach);
            root.style.setProperty('--lcars-sunflower', palette.sunflower);
            root.style.setProperty('--lcars-blue', palette.violet);
            root.style.setProperty('--lcars-purple', palette.ice);
            root.style.setProperty('--lcars-alert', palette.tomato);
            
            console.log('Applied LCARS palette:', paletteName);
        }
        
        // =================================================================
        // Telemetry updates
        // =================================================================
        
        function updateTelemetry(t) {
            // Add to history for charts (W4)
            addTelemetrySample(t);
            
            // Power
            document.getElementById('battery-v').textContent = t.battery_v.toFixed(2);
            document.getElementById('current-a').textContent = t.current_a.toFixed(2);
            
            const batteryPct = Math.max(0, Math.min(100, (t.battery_v - 10.0) / 2.6 * 100));
            document.getElementById('battery-bar').style.width = batteryPct + '%';
            
            const lowBattEl = document.getElementById('low-battery-status');
            lowBattEl.textContent = t.low_battery_active ? 'ACTIVE' : 'OK';
            lowBattEl.className = 'lcars-data-value ' + (t.low_battery_active ? 'alert' : 'ok');
            
            // IMU
            updateIMUGauge('pitch', t.imu_pitch);
            updateIMUGauge('roll', t.imu_roll);
            updateIMUGauge('yaw', t.imu_yaw);
            
            // Servos
            document.getElementById('servo-temp').textContent = t.servo_temp_max.toFixed(1) + '¬∞C';
            document.getElementById('servo-volt').textContent = t.servo_volt_min.toFixed(2) + 'V';
            document.getElementById('servo-errors').textContent = t.servo_errors;
            
            const tempPct = Math.max(0, Math.min(100, t.servo_temp_max / 80 * 100));
            document.getElementById('temp-bar').style.width = tempPct + '%';
            
            // Status
            updateStatus('xbox-status', t.xbox_connected, 'Online', 'Offline');
            updateStatus('teensy-status', t.teensy_connected, 'Online', 'Offline');
            updateStatus('gait-status', t.gait_running, 'Active', 'Idle');
            
            const safetyEl = document.getElementById('safety-status');
            safetyEl.textContent = t.safety_state;
            safetyEl.className = 'lcars-status-state ' + 
                (t.safety_state === 'OK' || t.safety_state === '---' ? 'on' : 'off');
            document.getElementById('safety-cause').textContent = t.safety_cause || '---';
            
            // Robot banner
            const banner = document.getElementById('robot-banner');
            banner.className = 'lcars-banner ' + (t.robot_enabled ? 'enabled' : 'disabled');
            banner.textContent = t.robot_enabled ? 'Robot Enabled' : 'Robot Disabled';
            
            // Gait
            document.getElementById('gait-type').textContent = t.gait_type;
            document.getElementById('gait-speed').textContent = (t.gait_speed * 100).toFixed(0) + '%';
            document.getElementById('gait-running').textContent = t.gait_running ? 'Yes' : 'No';
            
            // System
            document.getElementById('loop-time').textContent = (t.loop_time_us / 1000).toFixed(2) + ' ms';
            document.getElementById('fw-version').textContent = t.fw_version || '---';
            document.getElementById('ctrl-version').textContent = t.ctrl_version || '---';
            
            // Timestamp
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
        }
        
        function updateIMUGauge(axis, degrees) {
            // For pitch/roll, use a wider range for visualization. 
            // -45 to +45 deg input maps to -90 to +90 deg rotation on gauge
            let clamped = Math.max(-45, Math.min(45, degrees));
            let rotation = clamped * 2; 

            // Handle Yaw (0-360) differently if needed, but assuming relative -45/+45 for now
            if (axis === 'yaw') {
                // Yaw is 0-360 usually, map to full circle? or just deviation?
                // For now, treat same as pitch/roll drift
                 rotation = clamped * 2;
            }

            const valEl = document.getElementById(axis + '-value');
            const needleEl = document.getElementById(axis + '-needle');

            if (valEl) valEl.textContent = degrees.toFixed(1) + '¬∞';
            if (needleEl) needleEl.style.transform = `rotate(${rotation}deg)`;
        }
        
        function updateStatus(id, isOn, onText, offText) {
            const el = document.getElementById(id);
            el.textContent = isOn ? onText : offText;
            el.className = 'lcars-status-state ' + (isOn ? 'on' : 'off');
        }
        
        // =================================================================
        // Configuration
        // =================================================================
        
        // Editable config items: section -> [keys that can be edited]
        const EDITABLE_CONFIG = {
            'Gait': ['Cycle Time', 'Step Length', 'Step Height', 'Turn Rate', 'FG Margin', 'FG Max Swing', 'FG Speed'],
            'Safety': [
                'Low Batt Prot', 'Volt Critical', 'Volt Recovery', 'LowBatt Filter',
                'Col Enabled', 'Col Stop', 'Col WarnOnly',
                'Leg Radius', 'Safety Margin', 'Body Keepout', 'Vel Horizon', 'Vel Margin Max',
                'Pose Log', 'Pose Log Hz'
            ],
            'PID': ['PID Enabled', 'Kp', 'Ki', 'Kd', 'Max Correction'],
            'Impedance': ['IMP Enabled', 'Kp', 'Kd', 'Max Force'],
            'Estimator': ['EST Alpha', 'Velocity Decay'],
            'System': ['Col Overlay'],
        };
        
        function isEditable(section, key) {
            const editableKeys = EDITABLE_CONFIG[section];
            if (!editableKeys) return false;
            // Match key case-insensitively
            const normalizedKey = key.toLowerCase();
            return editableKeys.some(k => k.toLowerCase() === normalizedKey);
        }
        
        function getEditableKey(section, displayKey) {
            // Return the display key as-is (menu uses labels as keys)
            return displayKey;
        }
        
        function renderConfig() {
            const container = document.getElementById('config-container');
            const searchTerm = (document.getElementById('config-search')?.value || '').toLowerCase();
            
            if (!config || Object.keys(config).length === 0) {
                container.innerHTML = '<div class="lcars-config-empty">No configuration data</div>';
                return;
            }
            
            const categoryOrder = ['Info', 'Gait', 'Posture', 'Safety', 'Eyes', 
                'PID', 'Impedance', 'Estimator', 'IMU', 'ToF', 'Autonomy', 'System'];
            
            const sortedCategories = Object.keys(config).sort((a, b) => {
                const aIdx = categoryOrder.indexOf(a);
                const bIdx = categoryOrder.indexOf(b);
                if (aIdx === -1 && bIdx === -1) return a.localeCompare(b);
                if (aIdx === -1) return 1;
                if (bIdx === -1) return -1;
                return aIdx - bIdx;
            });
            
            let html = '';
            let totalVisible = 0;
            
            for (const section of sortedCategories) {
                const values = config[section];
                const isCollapsed = collapsedCategories.has(section);
                
                const filteredItems = Object.entries(values).filter(([key, itemData]) => {
                    if (!searchTerm) return true;
                    const displayVal = typeof itemData === 'object' ? (itemData.display || '') : String(itemData);
                    return key.toLowerCase().includes(searchTerm) || 
                           displayVal.toLowerCase().includes(searchTerm) ||
                           section.toLowerCase().includes(searchTerm);
                });
                
                if (searchTerm && filteredItems.length === 0) continue;
                totalVisible += filteredItems.length;
                
                html += `<div class="lcars-config-category ${isCollapsed ? 'collapsed' : ''}" data-category="${section}">`;
                html += `<div class="lcars-config-header" onclick="toggleCategory('${section}')">
                    <span><span class="lcars-config-title">${section}</span><span class="lcars-config-count">(${Object.keys(values).length})</span></span>
                    <span class="lcars-config-toggle">‚ñº</span>
                </div>`;
                html += '<div class="lcars-config-items">';
                
                for (const [key, itemData] of filteredItems) {
                    const editable = isEditable(section, key);
                    const configKey = getEditableKey(section, key);
                    
                    // Extract metadata from new format or handle legacy simple values
                    const isNewFormat = typeof itemData === 'object' && itemData !== null && 'display' in itemData;
                    const displayValue = isNewFormat ? itemData.display : itemData;
                    const rawValue = isNewFormat ? itemData.raw_value : itemData;
                    const itemType = isNewFormat ? itemData.type : null;
                    const minVal = isNewFormat ? itemData.min : null;
                    const maxVal = isNewFormat ? itemData.max : null;
                    const step = isNewFormat ? itemData.step : null;
                    const unit = isNewFormat ? (itemData.unit || '') : '';
                    const options = isNewFormat ? itemData.options : null;
                    
                    if (editable && itemType === 'value') {
                        // Numeric value with constraints
                        const minAttr = minVal !== null && minVal !== undefined ? `min="${minVal}"` : '';
                        const maxAttr = maxVal !== null && maxVal !== undefined ? `max="${maxVal}"` : '';
                        const stepAttr = step !== null && step !== undefined ? `step="${step}"` : 'step="any"';
                        
                        // Format value to match step precision
                        let formattedValue = rawValue;
                        if (step !== null && step !== undefined && typeof rawValue === 'number') {
                            const decimals = step < 1 ? Math.ceil(-Math.log10(step)) : 0;
                            formattedValue = rawValue.toFixed(decimals);
                        }
                        
                        html += `<div class="lcars-config-item" data-section="${section}" data-key="${configKey}">
                            <span class="lcars-config-label">${key}${unit ? ' (' + unit + ')' : ''}</span>
                            <input type="number" class="lcars-config-input" 
                                   value="${formattedValue}" ${minAttr} ${maxAttr} ${stepAttr}
                                   onchange="setConfig('${section}', '${configKey}', parseFloat(this.value))"
                                   onkeydown="if(event.key==='Enter'){this.blur();}">
                        </div>`;
                    } else if (editable && itemType === 'option' && options) {
                        // Dropdown for option type
                        let optionsHtml = options.map((opt, idx) => 
                            `<option value="${idx}" ${idx === rawValue ? 'selected' : ''}>${opt}</option>`
                        ).join('');
                        html += `<div class="lcars-config-item" data-section="${section}" data-key="${configKey}">
                            <span class="lcars-config-label">${key}</span>
                            <select class="lcars-config-select"
                                    onchange="setConfig('${section}', '${configKey}', parseInt(this.value))">
                                ${optionsHtml}
                            </select>
                        </div>`;
                    } else if (editable && (typeof rawValue === 'boolean' || displayValue === 'On' || displayValue === 'Off')) {
                        // Boolean toggle
                        const isChecked = rawValue === true || rawValue === 1 || displayValue === 'On';
                        html += `<div class="lcars-config-item" data-section="${section}" data-key="${configKey}">
                            <span class="lcars-config-label">${key}</span>
                            <input type="checkbox" class="lcars-config-checkbox" 
                                   ${isChecked ? 'checked' : ''} 
                                   onchange="setConfig('${section}', '${configKey}', this.checked ? 1 : 0)">
                        </div>`;
                    } else {
                        // Read-only item
                        html += `<div class="lcars-config-item">
                            <span class="lcars-config-label">${key}</span>
                            <span class="lcars-config-value">${formatValue(displayValue)}</span>
                        </div>`;
                    }
                }
                
                html += '</div></div>';
            }
            
            if (searchTerm && totalVisible === 0) {
                html = `<div class="lcars-config-empty">No results for "${searchTerm}"</div>`;
            }
            
            container.innerHTML = html;
        }
        
        function toggleCategory(category) {
            if (collapsedCategories.has(category)) {
                collapsedCategories.delete(category);
            } else {
                collapsedCategories.add(category);
            }
            renderConfig();
        }
        
        function filterConfig(term) {
            renderConfig();
        }
        
        function formatValue(value) {
            if (typeof value === 'boolean') return value ? '‚úì On' : '‚úó Off';
            if (typeof value === 'number') return Number.isInteger(value) ? value.toString() : value.toFixed(2);
            return String(value);
        }
        
        // =================================================================
        // Config Editing
        // =================================================================
        
        function setConfig(section, key, value) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.error('WebSocket not connected');
                return;
            }
            
            // Send set_config command
            const cmd = {
                cmd: 'set_config',
                section: section,
                key: key,
                value: value
            };
            
            console.log('[Dashboard] Setting config:', cmd);
            ws.send(JSON.stringify(cmd));
        }
        
        function handleConfigResult(data) {
            if (data.success) {
                console.log(`[Dashboard] Config set: ${data.section}.${data.key} = ${data.value}`);
            } else {
                console.error(`[Dashboard] Config failed: ${data.section}.${data.key}`, data.error);
                // Could show a toast notification here
            }
        }
        
        // =================================================================
        // Start
        // =================================================================
        init();
    </script>
</body>
</html>
