<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARS Point Cloud Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
        }
        
        #info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            min-width: 200px;
            z-index: 100;
        }
        
        #info-panel h2 {
            color: #ff6b35;
            font-size: 16px;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 13px;
        }
        
        .stat-label {
            color: #888;
        }
        
        .stat-value {
            color: #4ecdc4;
            font-family: monospace;
        }
        
        #status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4444;
            margin-right: 8px;
        }
        
        #status.connected {
            background: #44ff44;
        }
        
        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
        }
        
        button {
            background: #4ecdc4;
            border: none;
            color: #1a1a2e;
            padding: 8px 16px;
            margin: 3px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #45b7aa;
        }
        
        button.active {
            background: #ff6b35;
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        #pose-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            min-width: 180px;
            z-index: 100;
        }
        
        #pose-panel h3 {
            color: #ff6b35;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .pose-axis {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin: 3px 0;
        }
        
        .axis-x { color: #ff6b6b; }
        .axis-y { color: #69db7c; }
        .axis-z { color: #74c0fc; }
        
        #help {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 11px;
            color: #888;
            z-index: 100;
        }
        
        #connection-input {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            z-index: 200;
        }
        
        #connection-input.hidden {
            display: none;
        }
        
        #connection-input h2 {
            color: #ff6b35;
            margin-bottom: 20px;
        }
        
        #connection-input input {
            background: #333;
            border: 1px solid #555;
            color: #eee;
            padding: 10px;
            border-radius: 4px;
            width: 250px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        #connection-input input:focus {
            outline: none;
            border-color: #4ecdc4;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <!-- Connection dialog -->
    <div id="connection-input">
        <h2>ü§ñ MARS Point Cloud</h2>
        <p style="margin-bottom: 15px; color: #888;">Enter WebSocket server address:</p>
        <input type="text" id="ws-address" placeholder="ws://192.168.1.100:8765" value="">
        <br>
        <button onclick="connect()">Connect</button>
    </div>
    
    <!-- Info panel -->
    <div id="info-panel">
        <h2><span id="status"></span>Point Cloud</h2>
        <div class="stat-row">
            <span class="stat-label">Points:</span>
            <span class="stat-value" id="point-count">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">FPS:</span>
            <span class="stat-value" id="fps">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Mode:</span>
            <span class="stat-value" id="mode">Live</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Latency:</span>
            <span class="stat-value" id="latency">--</span>
        </div>
    </div>
    
    <!-- Pose panel -->
    <div id="pose-panel">
        <h3>Robot Pose</h3>
        <div class="pose-axis">
            <span class="axis-x">X:</span>
            <span class="stat-value" id="pos-x">0.0</span>
        </div>
        <div class="pose-axis">
            <span class="axis-y">Y:</span>
            <span class="stat-value" id="pos-y">0.0</span>
        </div>
        <div class="pose-axis">
            <span class="axis-z">Z:</span>
            <span class="stat-value" id="pos-z">0.0</span>
        </div>
        <hr style="margin: 8px 0; border-color: #444;">
        <div class="pose-axis">
            <span class="stat-label">Roll:</span>
            <span class="stat-value" id="rot-roll">0.0¬∞</span>
        </div>
        <div class="pose-axis">
            <span class="stat-label">Pitch:</span>
            <span class="stat-value" id="rot-pitch">0.0¬∞</span>
        </div>
        <div class="pose-axis">
            <span class="stat-label">Yaw:</span>
            <span class="stat-value" id="rot-yaw">0.0¬∞</span>
        </div>
    </div>
    
    <!-- Controls -->
    <div id="controls">
        <button id="btn-live" class="active" onclick="setMode('live')">Live</button>
        <button id="btn-accumulate" onclick="setMode('accumulate')">Accumulate</button>
        <button onclick="clearPoints()">Clear</button>
        <button onclick="resetView()">Reset View</button>
        <button onclick="togglePause()" id="btn-pause">Pause</button>
        <button onclick="resetPose()">Reset Pose</button>
    </div>
    
    <!-- Help -->
    <div id="help">
        üñ±Ô∏è Drag to rotate | Scroll to zoom | Right-drag to pan
    </div>
    
    <!-- Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <script>
        // =================================================================
        // Global state
        // =================================================================
        let scene, camera, renderer, controls;
        let pointCloud, robotMarker, gridHelper, axesHelper;
        let ws = null;
        let isPaused = false;
        let currentMode = 'live';
        
        // Performance tracking
        let frameCount = 0;
        let lastFpsTime = performance.now();
        let lastFrameTime = 0;
        
        // Point cloud data
        const MAX_POINTS = 100000;
        let positions, colors;
        let pointCount = 0;
        
        // =================================================================
        // Initialization
        // =================================================================
        
        function init() {
            const container = document.getElementById('container');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            
            // Camera
            camera = new THREE.PerspectiveCamera(
                60,
                window.innerWidth / window.innerHeight,
                1,
                50000
            );
            camera.position.set(1000, 1000, 1000);
            camera.lookAt(0, 0, 0);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            
            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = true;
            controls.minDistance = 100;
            controls.maxDistance = 20000;
            
            // Grid (XY plane, Z up)
            gridHelper = new THREE.GridHelper(5000, 50, 0x444444, 0x333333);
            gridHelper.rotation.x = Math.PI / 2;  // Rotate to XY plane
            scene.add(gridHelper);
            
            // Axes helper (X=red, Y=green, Z=blue)
            axesHelper = new THREE.AxesHelper(500);
            scene.add(axesHelper);
            
            // Point cloud geometry
            const geometry = new THREE.BufferGeometry();
            positions = new Float32Array(MAX_POINTS * 3);
            colors = new Float32Array(MAX_POINTS * 3);
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.setDrawRange(0, 0);
            
            const material = new THREE.PointsMaterial({
                size: 15,
                vertexColors: true,
                sizeAttenuation: true
            });
            
            pointCloud = new THREE.Points(geometry, material);
            scene.add(pointCloud);
            
            // Robot marker (simple arrow showing direction)
            const robotGeom = new THREE.ConeGeometry(30, 80, 8);
            robotGeom.rotateX(Math.PI / 2);
            const robotMat = new THREE.MeshBasicMaterial({ color: 0xff6b35 });
            robotMarker = new THREE.Mesh(robotGeom, robotMat);
            scene.add(robotMarker);
            
            // Add robot body outline
            const bodyGeom = new THREE.CircleGeometry(60, 6);
            const bodyMat = new THREE.MeshBasicMaterial({ 
                color: 0xff6b35, 
                transparent: true, 
                opacity: 0.3,
                side: THREE.DoubleSide
            });
            const bodyMesh = new THREE.Mesh(bodyGeom, bodyMat);
            bodyMesh.rotation.x = -Math.PI / 2;
            robotMarker.add(bodyMesh);
            
            // Ambient lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            // Handle resize
            window.addEventListener('resize', onWindowResize);
            
            // Start render loop
            animate();
            
            // Try to auto-connect
            const hostname = window.location.hostname || 'localhost';
            document.getElementById('ws-address').value = `ws://${hostname}:8765`;
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
            
            // Update FPS
            frameCount++;
            const now = performance.now();
            if (now - lastFpsTime >= 1000) {
                document.getElementById('fps').textContent = frameCount;
                frameCount = 0;
                lastFpsTime = now;
            }
        }
        
        // =================================================================
        // WebSocket connection
        // =================================================================
        
        function connect() {
            const address = document.getElementById('ws-address').value;
            
            if (ws) {
                ws.close();
            }
            
            try {
                ws = new WebSocket(address);
                
                ws.onopen = () => {
                    console.log('Connected to', address);
                    document.getElementById('status').classList.add('connected');
                    document.getElementById('connection-input').classList.add('hidden');
                };
                
                ws.onclose = () => {
                    console.log('Disconnected');
                    document.getElementById('status').classList.remove('connected');
                    document.getElementById('connection-input').classList.remove('hidden');
                };
                
                ws.onerror = (err) => {
                    console.error('WebSocket error:', err);
                };
                
                ws.onmessage = (event) => {
                    handleMessage(JSON.parse(event.data));
                };
                
            } catch (err) {
                console.error('Connection failed:', err);
                alert('Failed to connect: ' + err.message);
            }
        }
        
        function handleMessage(data) {
            if (data.type === 'frame') {
                updatePointCloud(data.points);
                updatePose(data.pose);
                
                document.getElementById('point-count').textContent = data.point_count;
                
                // Calculate latency
                if (data.timestamp) {
                    const latency = performance.now() - (data.timestamp % 1000000);
                    document.getElementById('latency').textContent = 
                        latency > 0 && latency < 1000 ? `${latency.toFixed(0)}ms` : '--';
                }
            }
            else if (data.type === 'config') {
                console.log('Server config:', data);
            }
        }
        
        function updatePointCloud(points) {
            if (!points || points.length === 0) return;
            
            const count = Math.min(points.length, MAX_POINTS);
            pointCount = count;
            
            for (let i = 0; i < count; i++) {
                const p = points[i];
                const idx = i * 3;
                
                // Position (x, y, z) - swap Y and Z for Three.js (Y-up)
                positions[idx] = p[0];      // X
                positions[idx + 1] = p[2];  // Z -> Y (up)
                positions[idx + 2] = -p[1]; // -Y -> Z (forward becomes -Z in Three.js)
                
                // Color (r, g, b normalized to 0-1)
                colors[idx] = p[3] / 255;
                colors[idx + 1] = p[4] / 255;
                colors[idx + 2] = p[5] / 255;
            }
            
            // Update geometry
            pointCloud.geometry.attributes.position.needsUpdate = true;
            pointCloud.geometry.attributes.color.needsUpdate = true;
            pointCloud.geometry.setDrawRange(0, count);
        }
        
        function updatePose(pose) {
            if (!pose) return;
            
            const pos = pose.position;
            const rot = pose.rotation;
            
            // Update robot marker (swap axes for Three.js)
            robotMarker.position.set(pos[0], pos[2], -pos[1]);
            robotMarker.rotation.set(rot[0], rot[2], -rot[1], 'YXZ');
            
            // Update UI
            document.getElementById('pos-x').textContent = pos[0].toFixed(0) + ' mm';
            document.getElementById('pos-y').textContent = pos[1].toFixed(0) + ' mm';
            document.getElementById('pos-z').textContent = pos[2].toFixed(0) + ' mm';
            
            document.getElementById('rot-roll').textContent = (rot[0] * 180 / Math.PI).toFixed(1) + '¬∞';
            document.getElementById('rot-pitch').textContent = (rot[1] * 180 / Math.PI).toFixed(1) + '¬∞';
            document.getElementById('rot-yaw').textContent = (rot[2] * 180 / Math.PI).toFixed(1) + '¬∞';
        }
        
        // =================================================================
        // Controls
        // =================================================================
        
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('mode').textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
            
            document.getElementById('btn-live').classList.toggle('active', mode === 'live');
            document.getElementById('btn-accumulate').classList.toggle('active', mode === 'accumulate');
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ cmd: 'set_mode', mode: mode }));
            }
        }
        
        function clearPoints() {
            // Clear local
            pointCloud.geometry.setDrawRange(0, 0);
            document.getElementById('point-count').textContent = '0';
            
            // Tell server to clear
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ cmd: 'clear' }));
            }
        }
        
        function resetView() {
            camera.position.set(1000, 1000, 1000);
            camera.lookAt(0, 0, 0);
            controls.reset();
        }
        
        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('btn-pause').textContent = isPaused ? 'Resume' : 'Pause';
            document.getElementById('btn-pause').classList.toggle('active', isPaused);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ cmd: isPaused ? 'pause' : 'resume' }));
            }
        }
        
        function resetPose() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ cmd: 'reset_pose' }));
            }
            robotMarker.position.set(0, 0, 0);
            robotMarker.rotation.set(0, 0, 0);
        }
        
        // =================================================================
        // Start
        // =================================================================
        
        init();
    </script>
</body>
</html>
