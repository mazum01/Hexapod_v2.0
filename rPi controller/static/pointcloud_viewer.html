<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARS Point Cloud — LCARS</title>
    <style>
        /* ================================================================
           LCARS Theme for MARS Point Cloud Viewer
           ================================================================ */
        
        @import url('https://fonts.googleapis.com/css2?family=Antonio:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* LCARS color palette */
            --lcars-black: #000000;
            --lcars-orange: #ff9900;
            --lcars-peach: #ffcc99;
            --lcars-tan: #cc9966;
            --lcars-gold: #cc6600;
            --lcars-blue: #9999ff;
            --lcars-purple: #cc99cc;
            --lcars-magenta: #cc6699;
            --lcars-red: #cc4444;
            --lcars-green: #99cc66;
            --lcars-cyan: #66cccc;
            --lcars-lavender: #9977aa;
        }
        
        body {
            font-family: 'Antonio', 'Helvetica Neue', Arial, sans-serif;
            background: var(--lcars-black);
            color: var(--lcars-peach);
            overflow: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
        }
        
        /* LCARS Panel styling */
        .lcars-panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid var(--lcars-tan);
            border-radius: 0 20px 20px 0;
            overflow: hidden;
            z-index: 100;
        }
        
        .lcars-panel::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 8px;
            height: 100%;
            background: var(--lcars-tan);
        }
        
        .lcars-panel-header {
            padding: 10px 15px 10px 20px;
            background: linear-gradient(90deg, var(--lcars-tan) 0%, rgba(204, 153, 102, 0.3) 30%, transparent 100%);
            border-bottom: 1px solid var(--lcars-tan);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .lcars-panel-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--lcars-peach);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .lcars-panel-content {
            padding: 12px 15px 12px 20px;
        }
        
        #info-panel {
            top: 10px;
            left: 10px;
            min-width: 220px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 13px;
        }
        
        .stat-label {
            color: var(--lcars-tan);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 11px;
        }
        
        .stat-value {
            color: var(--lcars-orange);
            font-family: 'Antonio', monospace;
            font-weight: 700;
            font-size: 16px;
        }
        
        #status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--lcars-red);
            border: 2px solid var(--lcars-black);
        }
        
        #status.connected {
            background: var(--lcars-green);
            box-shadow: 0 0 8px var(--lcars-green);
        }
        
        #controls {
            bottom: 10px;
            left: 10px;
        }
        
        .lcars-button-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 12px 15px 12px 20px;
        }
        
        button {
            background: var(--lcars-blue);
            border: none;
            color: #000;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Antonio', sans-serif;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        
        button:hover {
            background: var(--lcars-peach);
            transform: scale(1.05);
        }
        
        button.active {
            background: var(--lcars-orange);
        }
        
        button:disabled {
            background: #444;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        #pose-panel {
            top: 10px;
            right: 10px;
            min-width: 200px;
        }
        
        .pose-axis {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin: 6px 0;
        }
        
        .axis-x { color: #ff6b6b; }
        .axis-y { color: #69db7c; }
        .axis-z { color: #74c0fc; }
        
        .pose-divider {
            border: none;
            border-top: 1px solid var(--lcars-tan);
            margin: 10px 0;
        }
        
        #help {
            bottom: 10px;
            right: 10px;
            padding: 10px 15px 10px 20px;
            font-size: 11px;
            color: var(--lcars-tan);
            letter-spacing: 1px;
        }
        
        /* Connection dialog - LCARS style */
        #connection-input {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--lcars-black);
            border: 3px solid var(--lcars-orange);
            border-radius: 0 40px 40px 0;
            text-align: center;
            z-index: 200;
            overflow: hidden;
            min-width: 400px;
        }
        
        #connection-input::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 20px;
            height: 100%;
            background: var(--lcars-orange);
        }
        
        #connection-input.hidden {
            display: none;
        }
        
        .connection-inner {
            padding: 30px 30px 30px 40px;
        }
        
        #connection-input h2 {
            color: var(--lcars-orange);
            margin-bottom: 10px;
            font-size: 28px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        #connection-input p {
            color: var(--lcars-tan);
            margin-bottom: 15px;
            font-size: 14px;
            letter-spacing: 1px;
        }
        
        #connection-input input {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--lcars-blue);
            color: var(--lcars-peach);
            padding: 15px 20px;
            border-radius: 25px;
            width: 280px;
            margin-bottom: 20px;
            font-size: 16px;
            font-family: 'Antonio', sans-serif;
        }
        
        #connection-input input:focus {
            outline: none;
            border-color: var(--lcars-orange);
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.3);
        }
        
        #connection-input button {
            padding: 15px 40px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <!-- Connection dialog -->
    <div id="connection-input">
        <div class="connection-inner">
            <h2>Point Cloud</h2>
            <p>Spatial Telemetry System</p>
            <p>Enter WebSocket server address:</p>
            <input type="text" id="ws-address" placeholder="ws://192.168.1.100:8765" value="">
            <br>
            <button onclick="connect()">ENGAGE</button>
        </div>
    </div>
    
    <!-- Info panel -->
    <div id="info-panel" class="lcars-panel">
        <div class="lcars-panel-header">
            <span id="status"></span>
            <span class="lcars-panel-title">Point Cloud</span>
        </div>
        <div class="lcars-panel-content">
            <div class="stat-row">
                <span class="stat-label">Points</span>
                <span class="stat-value" id="point-count">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">FPS</span>
                <span class="stat-value" id="fps">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Mode</span>
                <span class="stat-value" id="mode">Live</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Latency</span>
                <span class="stat-value" id="latency">--</span>
            </div>
        </div>
    </div>
    
    <!-- Pose panel -->
    <div id="pose-panel" class="lcars-panel">
        <div class="lcars-panel-header">
            <span class="lcars-panel-title">Robot Pose</span>
        </div>
        <div class="lcars-panel-content">
            <div class="pose-axis">
                <span class="axis-x">X</span>
                <span class="stat-value" id="pos-x">0.0</span>
            </div>
            <div class="pose-axis">
                <span class="axis-y">Y</span>
                <span class="stat-value" id="pos-y">0.0</span>
            </div>
            <div class="pose-axis">
                <span class="axis-z">Z</span>
                <span class="stat-value" id="pos-z">0.0</span>
            </div>
            <hr class="pose-divider">
            <div class="pose-axis">
                <span class="stat-label">Roll</span>
                <span class="stat-value" id="rot-roll">0.0°</span>
            </div>
            <div class="pose-axis">
                <span class="stat-label">Pitch</span>
                <span class="stat-value" id="rot-pitch">0.0°</span>
            </div>
            <div class="pose-axis">
                <span class="stat-label">Yaw</span>
                <span class="stat-value" id="rot-yaw">0.0°</span>
            </div>
        </div>
    </div>
    
    <!-- Controls -->
    <div id="controls" class="lcars-panel">
        <div class="lcars-button-row">
            <button id="btn-live" class="active" onclick="setMode('live')">Live</button>
            <button id="btn-accumulate" onclick="setMode('accumulate')">Accumulate</button>
            <button onclick="clearPoints()">Clear</button>
            <button onclick="resetView()">Reset View</button>
            <button onclick="togglePause()" id="btn-pause">Pause</button>
            <button onclick="resetPose()">Reset Pose</button>
        </div>
    </div>
    
    <!-- Help -->
    <div id="help" class="lcars-panel">
        DRAG: Rotate | SCROLL: Zoom | RIGHT-DRAG: Pan
    </div>
    
    <!-- Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <script>
        // =================================================================
        // Global state
        // =================================================================
        let scene, camera, renderer, controls;
        let pointCloud, robotMarker, gridHelper, axesHelper;
        let ws = null;
        let isPaused = false;
        let currentMode = 'live';
        
        // Performance tracking
        let frameCount = 0;
        let lastFpsTime = performance.now();
        let lastFrameTime = 0;
        
        // Point cloud data
        const MAX_POINTS = 100000;
        let positions, colors;
        let pointCount = 0;
        
        // =================================================================
        // Initialization
        // =================================================================
        
        function init() {
            const container = document.getElementById('container');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            
            // Camera
            camera = new THREE.PerspectiveCamera(
                60,
                window.innerWidth / window.innerHeight,
                1,
                50000
            );
            camera.position.set(1000, 1000, 1000);
            camera.lookAt(0, 0, 0);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            
            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = true;
            controls.minDistance = 100;
            controls.maxDistance = 20000;
            
            // Grid (XY plane, Z up) - LCARS tan colors
            gridHelper = new THREE.GridHelper(5000, 50, 0xcc9966, 0x664422);
            gridHelper.rotation.x = Math.PI / 2;  // Rotate to XY plane
            scene.add(gridHelper);
            
            // Axes helper (X=red, Y=green, Z=blue)
            axesHelper = new THREE.AxesHelper(500);
            scene.add(axesHelper);
            
            // Point cloud geometry
            const geometry = new THREE.BufferGeometry();
            positions = new Float32Array(MAX_POINTS * 3);
            colors = new Float32Array(MAX_POINTS * 3);
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.setDrawRange(0, 0);
            
            const material = new THREE.PointsMaterial({
                size: 18,
                vertexColors: true,
                sizeAttenuation: true
            });
            
            pointCloud = new THREE.Points(geometry, material);
            scene.add(pointCloud);
            
            // Robot marker (simple arrow showing direction) - LCARS orange
            const robotGeom = new THREE.ConeGeometry(30, 80, 8);
            robotGeom.rotateX(Math.PI / 2);
            const robotMat = new THREE.MeshBasicMaterial({ color: 0xff9900 });
            robotMarker = new THREE.Mesh(robotGeom, robotMat);
            scene.add(robotMarker);
            
            // Add robot body outline - LCARS orange with transparency
            const bodyGeom = new THREE.CircleGeometry(60, 6);
            const bodyMat = new THREE.MeshBasicMaterial({ 
                color: 0xff9900, 
                transparent: true, 
                opacity: 0.3,
                side: THREE.DoubleSide
            });
            const bodyMesh = new THREE.Mesh(bodyGeom, bodyMat);
            bodyMesh.rotation.x = -Math.PI / 2;
            robotMarker.add(bodyMesh);
            
            // Ambient lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            // Handle resize
            window.addEventListener('resize', onWindowResize);
            
            // Start render loop
            animate();
            
            // Try to auto-connect
            const hostname = window.location.hostname || 'localhost';
            document.getElementById('ws-address').value = `ws://${hostname}:8765`;
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
            
            // Update FPS
            frameCount++;
            const now = performance.now();
            if (now - lastFpsTime >= 1000) {
                document.getElementById('fps').textContent = frameCount;
                frameCount = 0;
                lastFpsTime = now;
            }
        }
        
        // =================================================================
        // WebSocket connection
        // =================================================================
        
        function connect() {
            const address = document.getElementById('ws-address').value;
            
            if (ws) {
                ws.close();
            }
            
            try {
                ws = new WebSocket(address);
                
                ws.onopen = () => {
                    console.log('Connected to', address);
                    document.getElementById('status').classList.add('connected');
                    document.getElementById('connection-input').classList.add('hidden');
                };
                
                ws.onclose = () => {
                    console.log('Disconnected');
                    document.getElementById('status').classList.remove('connected');
                    document.getElementById('connection-input').classList.remove('hidden');
                };
                
                ws.onerror = (err) => {
                    console.error('WebSocket error:', err);
                };
                
                ws.onmessage = (event) => {
                    handleMessage(JSON.parse(event.data));
                };
                
            } catch (err) {
                console.error('Connection failed:', err);
                alert('Failed to connect: ' + err.message);
            }
        }
        
        function handleMessage(data) {
            if (data.type === 'frame') {
                updatePointCloud(data.points);
                updatePose(data.pose);
                
                document.getElementById('point-count').textContent = data.point_count;
                
                // Calculate latency
                if (data.timestamp) {
                    const latency = performance.now() - (data.timestamp % 1000000);
                    document.getElementById('latency').textContent = 
                        latency > 0 && latency < 1000 ? `${latency.toFixed(0)}ms` : '--';
                }
            }
            else if (data.type === 'config') {
                console.log('Server config:', data);
            }
        }
        
        function updatePointCloud(points) {
            if (!points || points.length === 0) return;
            
            const count = Math.min(points.length, MAX_POINTS);
            pointCount = count;
            
            for (let i = 0; i < count; i++) {
                const p = points[i];
                const idx = i * 3;
                
                // Position (x, y, z) - swap Y and Z for Three.js (Y-up)
                positions[idx] = p[0];      // X
                positions[idx + 1] = p[2];  // Z -> Y (up)
                positions[idx + 2] = -p[1]; // -Y -> Z (forward becomes -Z in Three.js)
                
                // Color (r, g, b normalized to 0-1)
                colors[idx] = p[3] / 255;
                colors[idx + 1] = p[4] / 255;
                colors[idx + 2] = p[5] / 255;
            }
            
            // Update geometry
            pointCloud.geometry.attributes.position.needsUpdate = true;
            pointCloud.geometry.attributes.color.needsUpdate = true;
            pointCloud.geometry.setDrawRange(0, count);
        }
        
        function updatePose(pose) {
            if (!pose) return;
            
            const pos = pose.position;
            const rot = pose.rotation;
            
            // Update robot marker (swap axes for Three.js)
            robotMarker.position.set(pos[0], pos[2], -pos[1]);
            robotMarker.rotation.set(rot[0], rot[2], -rot[1], 'YXZ');
            
            // Update UI
            document.getElementById('pos-x').textContent = pos[0].toFixed(0) + ' mm';
            document.getElementById('pos-y').textContent = pos[1].toFixed(0) + ' mm';
            document.getElementById('pos-z').textContent = pos[2].toFixed(0) + ' mm';
            
            document.getElementById('rot-roll').textContent = (rot[0] * 180 / Math.PI).toFixed(1) + '°';
            document.getElementById('rot-pitch').textContent = (rot[1] * 180 / Math.PI).toFixed(1) + '°';
            document.getElementById('rot-yaw').textContent = (rot[2] * 180 / Math.PI).toFixed(1) + '°';
        }
        
        // =================================================================
        // Controls
        // =================================================================
        
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('mode').textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
            
            document.getElementById('btn-live').classList.toggle('active', mode === 'live');
            document.getElementById('btn-accumulate').classList.toggle('active', mode === 'accumulate');
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ cmd: 'set_mode', mode: mode }));
            }
        }
        
        function clearPoints() {
            // Clear local
            pointCloud.geometry.setDrawRange(0, 0);
            document.getElementById('point-count').textContent = '0';
            
            // Tell server to clear
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ cmd: 'clear' }));
            }
        }
        
        function resetView() {
            camera.position.set(1000, 1000, 1000);
            camera.lookAt(0, 0, 0);
            controls.reset();
        }
        
        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('btn-pause').textContent = isPaused ? 'Resume' : 'Pause';
            document.getElementById('btn-pause').classList.toggle('active', isPaused);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ cmd: isPaused ? 'pause' : 'resume' }));
            }
        }
        
        function resetPose() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ cmd: 'reset_pose' }));
            }
            robotMarker.position.set(0, 0, 0);
            robotMarker.rotation.set(0, 0, 0);
        }
        
        // =================================================================
        // Start
        // =================================================================
        
        init();
    </script>
</body>
</html>
